"use strict";angular.module("skypathApp",["ngAnimate","ngCookies","ngMessages","ngResource","ngRoute","ngSanitize","ngTouch","leaflet-directive","ui.bootstrap-slider"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl",controllerAs:"about"}).otherwise({redirectTo:"/"})}]).run(["$rootScope",function(a){a.latLng={lat:32.8,lng:34.5},a.initialZoom=6}]),angular.module("skypathApp").controller("MainCtrl",["$scope","$rootScope","leafletData","restService","mapTools",function(a,b,c,d,e){function f(a,b,c,d,e){this.tileX=a,this.tileY=b,this.severity=c,this.altitude=d,this.timestamp=e}var g,h=10,i=15,j=2,k=[];a.noOfTilesForAlt=0,a.noOfTilesForAltAndTime=0,a.noOfTotalTiles=0,a.altitudeToDisplay=1,a.currentAltitudeLabel="",a.currentTimeSpan=12,a.$watch("currentTimeSpan",function(){m(a.altitudeToDisplay)});var l=function(){d.getTurbulence().then(function(b){c.getMap().then(function(c){var d=b.data.turbulence;a.noOfTotalTiles=d.length,d.forEach(function(a){var b=new f(a.tileX,a.tileY,a.sev,a.alt,a.ts);b.altitude>=1&&k[b.altitude-1].push(b)}),m(a.altitudeToDisplay)})})},m=function(b){c.getMap().then(function(c){var d=k[b-1];a.noOfTilesForAlt=d.length,a.currentAltitudeLabel=(b-1)*j+h+"-"+(b*j+h),g.clearLayers();var f=new Date,i=f.getTime()/1e3;a.noOfTilesForAlt=d.length,a.noOfTilesForAltAndTime=0,d.forEach(function(b){var c=3600*a.currentTimeSpan;if(i-b.timestamp<c){var d=n(e.tile2lat(b.tileY,11),e.tile2long(b.tileX,11),e.tile2lat(b.tileY,11),e.tile2long(b.tileX+1,11))/2;L.circle([e.tile2lat(b.tileY+.5,11),e.tile2long(b.tileX+.5,11)],d,{color:e.getColorBySeverity(b.severity),fillColor:e.getColorBySeverity(b.severity),fillOpacity:1,weight:2}).addTo(g);a.noOfTilesForAltAndTime+=1}})})},n=function(a,b,c,d){var e=6371e3,f=a*Math.PI/180,g=c*Math.PI/180,h=(c-a)*Math.PI/180,i=(d-b)*Math.PI/180,j=Math.sin(h/2)*Math.sin(h/2)+Math.cos(f)*Math.cos(g)*Math.sin(i/2)*Math.sin(i/2),k=2*Math.atan2(Math.sqrt(j),Math.sqrt(1-j)),l=e*k;return l};a.viewMethods={goUP:function(){a.altitudeToDisplay<i&&(a.altitudeToDisplay+=1,m(a.altitudeToDisplay))},goDOWN:function(){a.altitudeToDisplay>1&&(a.altitudeToDisplay-=1,m(a.altitudeToDisplay))}},a.center={lat:b.latLng.lat,lng:b.latLng.lng,zoom:b.initialZoom-1},a.layers={baselayers:{grayscale:{name:"Grayscale",url:"https://api.mapbox.com/v4/mapbox.light/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoieml2bGV2eSIsImEiOiJwaEpQeUNRIn0.OZupy_Vjyl5eRCRlgV6otg",type:"xyz",layerOptions:{}},OpenStreetMap:{name:"Open Streen Map",url:"http://tile.openstreetmap.org/{z}/{x}/{y}.png",type:"xyz",layerOptions:{}},satellite:{name:"Satellite",url:"https://api.mapbox.com/v4/mapbox.light/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoieml2bGV2eSIsImEiOiJwaEpQeUNRIn0.OZupy_Vjyl5eRCRlgV6otg",type:"xyz",layerOptions:{}}},overlays:{}},a.controls={};for(var o=0;i>o;o++)k.push([]);c.getMap().then(function(a){g=(new L.FeatureGroup).addTo(a),L.control.scale().addTo(a)}),l()}]),angular.module("skypathApp").controller("AboutCtrl",function(){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}),angular.module("skypathApp").service("restService",["$http",function(a){var b="http://104.197.5.131:3000",c={},d=b+"/turbulence";return c.getTurbulence=function(){return a.get(d)},c}]),angular.module("skypathApp").service("mapTools",function(){var a={};return a.tile2long=function(a,b){return a/Math.pow(2,b)*360-180},a.tile2lat=function(a,b){var c=Math.PI-2*Math.PI*a/Math.pow(2,b);return 180/Math.PI*Math.atan((Math.exp(c)-Math.exp(-c))/2)},a.getColorBySeverity=function(a){switch(a){case 0:return"white";case 1:return"green";case 2:return"blue";case 3:return"yellow";case 4:return"red";case 5:return"black";default:return"white"}},a}),angular.module("skypathApp").run(["$templateCache",function(a){a.put("views/about.html",'<div class="row"> <br> </div> <div class="row"> <div class="jumbotron aboutPage"> <h1>Skypath</h1> <p>The turbulence hunter !</p> <p>&copy 2015</p> </div> </div>'),a.put("views/main.html",'<section> <div class="row" style="margin: 0"> <div class="col-sm-2"> <br> <div class="form-group" style="padding-left: 10px"> <!--debug buttons--> <!--<button ng-click="viewMethods.addTestData()">Add Test Data</button>--> <!-- altitude button--> <label>Choose Altitude</label> <button class="btn btn-info btn-block" type="button" ng-click="viewMethods.goUP()">Up </button> <pre style="margin-bottom: 0" class="text-center">{{currentAltitudeLabel}}</pre> <button class="btn btn-primary btn-block" type="button" ng-click="viewMethods.goDOWN()">Down </button> <br> <br> <!-- time controls--> <div class="form-group"> <label>Choose Time</label> <pre class="text-center">Last {{currentTimeSpan}} hours</pre> <slider ng-mouseup="executeMe()" ng-model="currentTimeSpan" min="12" step="12" max="504" value="12"></slider> <br> <label>Turbulence @ altitude / time</label> <pre class="text-center">{{noOfTilesForAltAndTime}} / {{noOfTilesForAlt}} events</pre> <br> <br> <label>Number of events in system</label> <pre class="text-center">{{noOfTotalTiles}} events</pre> </div> </div> </div> <div class="col-sm-10"> <leaflet center="center" layers="layers" controls class="mainmap" onstopslide="viewMethods.goDOWN()"></leaflet> </div> </div> {{altitudeToDisplay}} </section>')}]);