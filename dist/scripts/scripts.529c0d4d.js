"use strict";angular.module("skypathApp",["ngAnimate","ngCookies","ngMessages","ngResource","ngRoute","ngSanitize","ngTouch","leaflet-directive","ui.bootstrap-slider"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl",controllerAs:"about"}).otherwise({redirectTo:"/"})}]).run(["$rootScope",function(a){a.latLng={lat:32.8,lng:34.5},a.initialZoom=6}]),angular.module("skypathApp").controller("MainCtrl",["$scope","$rootScope","$filter","$window","leafletData","restService","mapTools",function(a,b,c,d,e,f,g){function h(a,b,c,d,e){this.tileX=a,this.tileY=b,this.severity=c,this.altitude=d,this.timestamp=e}var i,j=10,k=16,l=2,m=[],n=[];a.noOfTilesForAlt=0,a.noOfTilesForAltAndTime=0,a.noOfTotalTiles=0,a.altitudeToDisplay=11,a.currentAltitudeLabel="",a.currentTimeSpan=6,a.altUpDownCollapsed=!1,a.noOfTilesAtTimespan=0,a.displayAllAltitude=!1,a.selectedUITab=1,a.$watch("currentTimeSpan",function(){a.displayAllAltitude||q(a.altitudeToDisplay)});var o=function(){f.getTurbulence().then(function(b){e.getMap().then(function(c){var d=b.data.turbulence;a.noOfTotalTiles=d.length,d.forEach(function(a){var b=new h(a.tileX,a.tileY,a.sev,a.alt,a.ts);if(b.altitude>=1){m[b.altitude-1].push(b);var c=b.tileX+"|"+b.tileY;n.hasOwnProperty(c)?n[c].timestamp<b.timestamp&&(n[c]=b):n[c]=b}}),q(a.altitudeToDisplay)})})},p=function(){i.clearLayers(),a.noOfTilesAtTimespan=0;var b=new Date,c=b.getTime()/1e3;a.noOfTilesForAltAndTime=0,e.getMap().then(function(d){Object.keys(n).forEach(function(b){var d=n[b],e=3600*a.currentTimeSpan;if(c-d.timestamp<e){var f=r(g.tile2lat(d.tileY,11),g.tile2long(d.tileX,11),g.tile2lat(d.tileY,11),g.tile2long(d.tileX+1,11))/2;L.circle([g.tile2lat(d.tileY+.5,11),g.tile2long(d.tileX+.5,11)],f,{color:g.getColorBySeverity(d.severity),fillColor:g.getColorBySeverity(d.severity),fillOpacity:1,weight:2}).addTo(i);a.noOfTilesAtTimespan+=1}}),b=new Date;var e=b.getTime()/1e3;console.log("drawTurbulenceAtAllLevels finished:"+(e-c)+", noOfTilesAtTimespan:"+a.noOfTilesAtTimespan)})},q=function(b){e.getMap().then(function(c){var d=m[b-1];a.noOfTilesForAlt=d.length,a.currentAltitudeLabel=(b-1)*l+j+"-"+(b*l+j),i.clearLayers();var e=new Date,f=e.getTime()/1e3;a.noOfTilesForAlt=d.length,a.noOfTilesForAltAndTime=0,d.forEach(function(b){var c=3600*a.currentTimeSpan;if(f-b.timestamp<c){var d=r(g.tile2lat(b.tileY,11),g.tile2long(b.tileX,11),g.tile2lat(b.tileY,11),g.tile2long(b.tileX+1,11))/2;L.circle([g.tile2lat(b.tileY+.5,11),g.tile2long(b.tileX+.5,11)],d,{color:g.getColorBySeverity(b.severity),fillColor:g.getColorBySeverity(b.severity),fillOpacity:1,weight:2}).addTo(i);a.noOfTilesForAltAndTime+=1}}),e=new Date;var h=e.getTime()/1e3;console.log("drawTurbulenceAtAlt finished:"+(h-f))})},r=function(a,b,c,d){var e=6371e3,f=a*Math.PI/180,g=c*Math.PI/180,h=(c-a)*Math.PI/180,i=(d-b)*Math.PI/180,j=Math.sin(h/2)*Math.sin(h/2)+Math.cos(f)*Math.cos(g)*Math.sin(i/2)*Math.sin(i/2),k=2*Math.atan2(Math.sqrt(j),Math.sqrt(1-j)),l=e*k;return l};a.viewMethods={goUP:function(){a.altitudeToDisplay<k&&(a.altitudeToDisplay+=1,q(a.altitudeToDisplay))},goDOWN:function(){a.altitudeToDisplay>1&&(a.altitudeToDisplay-=1,q(a.altitudeToDisplay))},sliderMouseReleased:function(){p()},setDisplayAllTiles:function(){a.displayAllAltitude=!0,p()},setDisplayTilesByAltAndTime:function(){a.displayAllAltitude=!1,q(a.altitudeToDisplay)}},a.center={lat:b.latLng.lat,lng:b.latLng.lng,zoom:b.initialZoom-1},a.layers={baselayers:{grayscale:{name:"Grayscale",url:"https://api.mapbox.com/v4/mapbox.light/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoieml2bGV2eSIsImEiOiJwaEpQeUNRIn0.OZupy_Vjyl5eRCRlgV6otg",type:"xyz",layerOptions:{}},OpenStreetMap:{name:"Open Streen Map",url:"http://tile.openstreetmap.org/{z}/{x}/{y}.png",type:"xyz",layerOptions:{}},satellite:{name:"Satellite",url:"https://api.mapbox.com/v4/mapbox.light/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoieml2bGV2eSIsImEiOiJwaEpQeUNRIn0.OZupy_Vjyl5eRCRlgV6otg",type:"xyz",layerOptions:{}}},overlays:{}},a.controls={};for(var s=0;k>s;s++)m.push([]);e.getMap().then(function(b){function d(d){var e=g.long2tile(d.latlng.lng,11),f=g.lat2tile(d.latlng.lat,11),h="";if(a.displayAllAltitude){var i=e+"|"+f,j=n[i],k=new Date(1e3*j.timestamp),l=new Date(k.getUTCFullYear(),k.getUTCMonth(),k.getUTCDate(),k.getUTCHours(),k.getUTCMinutes(),k.getUTCSeconds());h=c("date")(l,"dd/MM HH:mm")+" GMT"}else for(var o=m[a.altitudeToDisplay-1].length-1;o>=0;o--){var j=m[a.altitudeToDisplay-1][o];if(j.tileX===e&&f===j.tileY){var k=new Date(1e3*j.timestamp),l=new Date(k.getUTCFullYear(),k.getUTCMonth(),k.getUTCDate(),k.getUTCHours(),k.getUTCMinutes(),k.getUTCSeconds());h=c("date")(l,"dd/MM HH:mm")+" GMT";break}}if(h){var p=L.popup({className:"popup-background"+j.severity});p.setLatLng(d.latlng).setContent("Created at "+h).openOn(b)}}i=(new L.FeatureGroup).addTo(b),i.on("click",d),L.control.scale().addTo(b)}),o(),angular.element(d).on("resize",function(){$('[name="leafletCtrl"]').height(.78*angular.element(d).height()).width(.8*angular.element(d).width()),e.getMap().then(function(a){a.invalidateSize()})}).trigger("resize")}]),angular.module("skypathApp").controller("AboutCtrl",function(){}),angular.module("skypathApp").service("restService",["$http",function(a){var b="http://104.197.5.131:3000",c={},d=b+"/turbulence";return c.getTurbulence=function(){return a.get(d)},c}]),angular.module("skypathApp").service("mapTools",function(){var a={};return a.tile2long=function(a,b){return a/Math.pow(2,b)*360-180},a.tile2lat=function(a,b){var c=Math.PI-2*Math.PI*a/Math.pow(2,b);return 180/Math.PI*Math.atan((Math.exp(c)-Math.exp(-c))/2)},a.long2tile=function(a,b){return Math.floor((a+180)/360*Math.pow(2,b))},a.lat2tile=function(a,b){return Math.floor((1-Math.log(Math.tan(a*Math.PI/180)+1/Math.cos(a*Math.PI/180))/Math.PI)/2*Math.pow(2,b))},a.getColorBySeverity=function(a){switch(a){case 0:return"white";case 1:return"#0EFF00";case 2:return"#F2FF0C";case 3:return"#FFA600";case 4:return"#FA0000";case 5:return"#FF00C3";default:return"white"}},a}),angular.module("skypathApp").run(["$templateCache",function(a){a.put("views/about.html",'<div class="row"> <br> </div> <div class="row"> <div class="jumbotron aboutPage"> <h1>Skypath</h1> <p>The turbulence hunter !</p> <p>&copy 2015</p> </div> </div>'),a.put("views/main.html",'<section> <div class="form-group"> <div class="col-md-2" style="padding-left:5px"> <br> <div class="form-group" style="background-color:#002000; border-radius: 5px"> <!--debug buttons--> <!--<button ng-click="viewMethods.addTestData()">Add Test Data</button>--> <!-- altitude button--> <ul class="nav nav-pills"> <li ng-class="{active: selectedUITab===1}"> <a href style="font-size:small" ng-click="viewMethods.setDisplayTilesByAltAndTime();selectedUITab=1">Filter by Alt.</a></li> <li ng-class="{active: selectedUITab===2}"><a href style="font-size:small" ng-click="viewMethods.setDisplayAllTiles();selectedUITab=2">Show all Alt.</a></li> </ul> <div ng-show="selectedUITab===1" style="padding: 15px"> <button class="btn btn-info btn-block" type="button" ng-click="viewMethods.goUP()">Up </button> <pre style="margin-bottom: 0;color:#000000" class="text-center">{{currentAltitudeLabel}}</pre> <button class="btn btn-primary btn-block" type="button" ng-click="viewMethods.goDOWN()">Down </button> <br> <br> <!-- time controls--> <label style="color:#C0C0C0">History</label> <pre style="color:#000000" class="text-center">Last {{currentTimeSpan}} hours</pre> <slider ng-model="currentTimeSpan" min="6" step="6" max="504"></slider> <br> <label style="color:#C0C0C0">Events at Alt. / time</label> <pre class="text-center">{{noOfTilesForAltAndTime}} / {{noOfTilesForAlt}} events</pre> <br> <br> <label style="color:#C0C0C0">Total events</label> <pre class="text-center" style="color:#000000">{{noOfTotalTiles}} events</pre> </div> <div ng-show="selectedUITab===2" id="all" style="padding: 15px"> <!-- time controls--> <label style="color:#C0C0C0">History</label> <pre style="color:#000000" class="text-center">Last {{currentTimeSpan}} hours</pre> <slider ng-model="currentTimeSpan" ng-mouseup="viewMethods.sliderMouseReleased()" min="6" step="6" max="504"></slider> <br> <label style="color:#C0C0C0">Events at timespan</label> <pre class="text-center">{{noOfTilesAtTimespan}}</pre> <br> <br> <label style="color:#C0C0C0">Total events</label> <pre class="text-center" style="color:#000000">{{noOfTotalTiles}} events</pre> </div> </div> </div> <div class="col-md-10"> <leaflet name="leafletCtrl" style="border-style: solid" center="center" layers="layers" controls class="mainmap"></leaflet> </div> </div> </section>')}]);