"use strict";angular.module("skypathApp",["ngAnimate","ngCookies","ngMessages","ngResource","ngRoute","ngSanitize","ngTouch","leaflet-directive","ui.bootstrap-slider"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl",controllerAs:"about"}).otherwise({redirectTo:"/"})}]).run(["$rootScope",function(a){a.latLng={lat:32.8,lng:34.5},a.initialZoom=6}]),angular.module("skypathApp").controller("MainCtrl",["$q","$scope","$rootScope","$filter","$window","leafletData","restService","mapTools",function(a,b,c,d,e,f,g,h){function i(a,b,c,d,e,f,g){this.tileX=a,this.tileY=b,this.severity=c,this.altitude=d,this.timestamp=e,this.empId=f,this.fNum=g}function j(){var a=.81;b.activateRawDataFiltering&&(a=.65),console.log("adjusting screen size, mapWidthPercentage:"+a),$('[name="leafletCtrl"]').height(.78*angular.element(e).height()).width(angular.element(e).width()*a),f.getMap().then(function(a){a.invalidateSize()})}var k,l,m=10,n=16,o=2,p=[],q=[],r=[];b.noOfTilesForAlt=0,b.noOfTilesForAltAndTime=0,b.noOfTotalTiles=0,b.altitudeToDisplay=11,b.currentAltitudeLabel="",b.currentTimeSpan=6,b.altUpDownCollapsed=!1,b.noOfTilesAtTimespan=0,b.displayAllAltitude=!1,b.selectedUITab=1,b.emplyeeIdFilterFromServer="",b.flightNumberFilterFromServer,b.tileReports=[],b.tileDataExpanded=!1,b.mapColWidth=10,b.sideBarColWidth=2,b.$watch("currentTimeSpan",function(){b.displayAllAltitude||w(b.altitudeToDisplay)}),b.$watch("activateRawDataFiltering",function(){void 0!==k&&k.clearLayers(),void 0!==l&&l.clearLayers(),b.activateRawDataFiltering?(b.mapColWidth=8,b.sideBarColWidth=4):(b.mapColWidth=10,b.sideBarColWidth=2),j()});var s=function(c,d){console.log("calling getReportByIdAndFNum with "+c+", "+d),r=[];var e=a.defer();return b.serverOperationInProgress=!0,g.getReportByIdAndFNum(c,d).then(function(a){500!==a.status&&void 0!==a.data?a.data.forEach(function(a){var c=new i(a.tileX,a.tileY,a.sev,a.alt,a.ts,a.repId,a.fNum);if(c.altitude>=1){var d=c.tileX+"|"+c.tileY;r.hasOwnProperty(d)||(r[d]=[]),r[d].push(c)}b.serverOperationInProgress=!1}):(console.log("Somthing went wrong."),b.serverOperationInProgress=!1),e.resolve(a)}),e.promise},t=function(a){f.getMap().then(function(a){k.clearLayers(),l.clearLayers();var b={};for(var c in r)if(r.hasOwnProperty(c)){var d=r[c];b={},d.sort(function(a,b){return a.timestamp-b.timestamp});for(var e=d.length-1;e>=0;e--){var f=d[e];void 0!==b.severity?b.severity<f.severity&&(b=f):b=f}var g=x(h.tile2lat(b.tileY,11),h.tile2long(b.tileX,11),h.tile2lat(b.tileY,11),h.tile2long(b.tileX+1,11))/2;L.circle([h.tile2lat(b.tileY+.5,11),h.tile2long(b.tileX+.5,11)],g,{color:h.getColorBySeverity(b.severity),fillColor:h.getColorBySeverity(b.severity),fillOpacity:1,weight:2}).addTo(l)}})},u=function(){b.serverOperationInProgress=!0,g.getTurbulence().then(function(a){var c=a.data.turbulence;b.noOfTotalTiles=c.length,c.forEach(function(a){var b=new i(a.tileX,a.tileY,a.sev,a.alt,a.ts);if(b.altitude>=1){p[b.altitude-1].push(b);var c=b.tileX+"|"+b.tileY;q.hasOwnProperty(c)?q[c].timestamp<b.timestamp&&(q[c]=b):q[c]=b}}),w(b.altitudeToDisplay),b.serverOperationInProgress=!1})},v=function(){k.clearLayers(),b.noOfTilesAtTimespan=0;var a=new Date,c=a.getTime()/1e3;b.noOfTilesForAltAndTime=0,console.log("currentTime:"+c),f.getMap().then(function(d){var e=3600*b.currentTimeSpan;console.log("timeDifferance:"+e),Object.keys(q).forEach(function(a){var d=q[a];if(c-d.timestamp<=e){var f=x(h.tile2lat(d.tileY,11),h.tile2long(d.tileX,11),h.tile2lat(d.tileY,11),h.tile2long(d.tileX+1,11))/2;L.circle([h.tile2lat(d.tileY+.5,11),h.tile2long(d.tileX+.5,11)],f,{color:h.getColorBySeverity(d.severity),fillColor:h.getColorBySeverity(d.severity),fillOpacity:1,weight:2}).addTo(k);b.noOfTilesAtTimespan+=1}}),a=new Date;var f=a.getTime()/1e3;console.log("drawTurbulenceAtAllLevels finished:"+(f-c)+", noOfTilesAtTimespan:"+b.noOfTilesAtTimespan)})},w=function(a){f.getMap().then(function(c){var d=p[a-1];b.noOfTilesForAlt=d.length,b.currentAltitudeLabel=(a-1)*o+m+"-"+(a*o+m),k.clearLayers();var e=new Date,f=e.getTime()/1e3;b.noOfTilesForAlt=d.length,b.noOfTilesForAltAndTime=0,d.forEach(function(a){var c=3600*b.currentTimeSpan;if(f-a.timestamp<c){var d=x(h.tile2lat(a.tileY,11),h.tile2long(a.tileX,11),h.tile2lat(a.tileY,11),h.tile2long(a.tileX+1,11))/2;L.circle([h.tile2lat(a.tileY+.5,11),h.tile2long(a.tileX+.5,11)],d,{color:h.getColorBySeverity(a.severity),fillColor:h.getColorBySeverity(a.severity),fillOpacity:1,weight:2}).addTo(k);b.noOfTilesForAltAndTime+=1}}),e=new Date;var g=e.getTime()/1e3;console.log("drawTurbulenceAtAlt finished:"+(g-f))})},x=function(a,b,c,d){var e=6371e3,f=a*Math.PI/180,g=c*Math.PI/180,h=(c-a)*Math.PI/180,i=(d-b)*Math.PI/180,j=Math.sin(h/2)*Math.sin(h/2)+Math.cos(f)*Math.cos(g)*Math.sin(i/2)*Math.sin(i/2),k=2*Math.atan2(Math.sqrt(j),Math.sqrt(1-j)),l=e*k;return l};b.viewMethods={reportFilter:function(){b.tileReports=[],(b.emplyeeIdFilterFromServer!=={}||void 0!==b.emplyeeIdFilterFromServer)&&s(b.emplyeeIdFilterFromServer,b.flightNumberFilterFromServer).then(function(a){t(a.data)})},goUP:function(){b.altitudeToDisplay<n&&(b.altitudeToDisplay+=1,w(b.altitudeToDisplay))},goDOWN:function(){b.altitudeToDisplay>1&&(b.altitudeToDisplay-=1,w(b.altitudeToDisplay))},sliderMouseReleased:function(){v()},setDisplayAllTiles:function(){b.displayAllAltitude=!0,v()},setDisplayTilesByAltAndTime:function(){b.displayAllAltitude=!1,w(b.altitudeToDisplay)}},b.center={lat:c.latLng.lat,lng:c.latLng.lng,zoom:c.initialZoom-1},b.layers={baselayers:{grayscale:{name:"Grayscale",url:"https://api.mapbox.com/v4/mapbox.light/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoieml2bGV2eSIsImEiOiJwaEpQeUNRIn0.OZupy_Vjyl5eRCRlgV6otg",type:"xyz",layerOptions:{}},OpenStreetMap:{name:"Open Streen Map",url:"http://tile.openstreetmap.org/{z}/{x}/{y}.png",type:"xyz",layerOptions:{}},satellite:{name:"Satellite",url:"https://api.mapbox.com/v4/mapbox.light/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoieml2bGV2eSIsImEiOiJwaEpQeUNRIn0.OZupy_Vjyl5eRCRlgV6otg",type:"xyz",layerOptions:{}}},overlays:{}},b.controls={};for(var y=0;n>y;y++)p.push([]);f.getMap().then(function(a){function c(c){var e=h.long2tile(c.latlng.lng,11),f=h.lat2tile(c.latlng.lat,11),g="";if(b.displayAllAltitude){var i=e+"|"+f,j=q[i],k=new Date(1e3*j.timestamp),l=new Date(k.getUTCFullYear(),k.getUTCMonth(),k.getUTCDate(),k.getUTCHours(),k.getUTCMinutes(),k.getUTCSeconds());g=d("date")(l,"dd/MM HH:mm")+" GMT"}else for(var m=p[b.altitudeToDisplay-1].length-1;m>=0;m--){var j=p[b.altitudeToDisplay-1][m];if(j.tileX===e&&f===j.tileY){var k=new Date(1e3*j.timestamp),l=new Date(k.getUTCFullYear(),k.getUTCMonth(),k.getUTCDate(),k.getUTCHours(),k.getUTCMinutes(),k.getUTCSeconds());g=d("date")(l,"dd/MM HH:mm")+" GMT";break}}if(g){var n=L.popup({className:"popup-background"+j.severity});n.setLatLng(c.latlng).setContent("Created at "+g).openOn(a)}}function e(a){var c=h.long2tile(a.latlng.lng,11),e=h.lat2tile(a.latlng.lat,11),f="",g=c+"|"+e,i=r[g];if(void 0===i)return void(b.tileDataExpanded=!1);b.tileDataExpanded=!0;for(var j=i.length-1;j>=0;j--){var k=new Date(1e3*i[j].timestamp),l=new Date(k.getUTCFullYear(),k.getUTCMonth(),k.getUTCDate(),k.getUTCHours(),k.getUTCMinutes(),k.getUTCSeconds());f=d("date")(l,"dd/MM HH:mm:ss"),i[j].humenTime=f,i[j].alt=2*i[j].altitude+10}b.tileReports=i}k=(new L.FeatureGroup).addTo(a),l=(new L.FeatureGroup).addTo(a),k.on("click",c),l.on("click",e),L.control.scale().addTo(a)}),u(),angular.element(e).on("resize",j).trigger("resize")}]),angular.module("skypathApp").controller("AboutCtrl",function(){});var skypathAppModule=angular.module("skypathApp"),token;skypathAppModule.config(["$httpProvider",function(a){a.interceptors.push(["$q",function(b){return{request:function(b){return a.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded",b},response:function(a){return a},responseError:function(a){return console.log(a),a}}}])}]),skypathAppModule.service("restService",["$http","$q",function(a,b){var c="http://104.197.5.131:3000",d={},e=c+"/turbulence";return d.getTurbulence=function(){return a.get(e+"/bytime?timespan=504")},d.getReportByIdAndFNum=function(b,d){if(void 0!==token){if(console.log("token has value"),void 0===d&&(d=""),void 0===b)return;return a.get(c+"/reports/filtered?empId="+b+"&fNum="+d,{headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*","x-access-token":token}})}console.log("token is not defined...")},d.logout=function(){token=void 0,console.log("dataFactory.logout::token now is "+token)},d.login=function(d,e){console.log("Trying to login"),console.log("username:"+d+", pwd:"+e);var f=b.defer();return a.post(c+"/login","username="+d+"&password="+e).then(function(a){a.data.success?(token=a.data.token,f.resolve(a)):(token="",f.reject(a))}),f.promise},d}]),angular.module("skypathApp").service("mapTools",function(){var a={};return a.tile2long=function(a,b){return a/Math.pow(2,b)*360-180},a.tile2lat=function(a,b){var c=Math.PI-2*Math.PI*a/Math.pow(2,b);return 180/Math.PI*Math.atan((Math.exp(c)-Math.exp(-c))/2)},a.long2tile=function(a,b){return Math.floor((a+180)/360*Math.pow(2,b))},a.lat2tile=function(a,b){return Math.floor((1-Math.log(Math.tan(a*Math.PI/180)+1/Math.cos(a*Math.PI/180))/Math.PI)/2*Math.pow(2,b))},a.getColorBySeverity=function(a){switch(a){case 0:return"white";case 1:return"#0EFF00";case 2:return"#F2FF0C";case 3:return"#FFA600";case 4:return"#FA0000";case 5:return"#FF00C3";default:return"white"}},a}),angular.module("skypathApp").controller("IndexCtrl",["$scope","restService",function(a,b){a.userName="",a.password="",a.loginInProgress=!1,a.serverOperationInProgress=!1,a.loginMessage="",a.loginButtonText="Log-in",a.loggedIn=!1,a.activateRawDataFiltering=!1,a.viewMethods={login:function(){a.loginInProgress=!0,a.loginMessage="",b.login(a.username,a.password).then(function(b){a.loginInProgress=!1,a.loginMessage=b.data.message,a.loginButtonText="Log-out",a.loggedIn=!0,angular.element($("#btnCloseLogin")).click(),a.loginMessage="",a.username="",a.password=""},function(b){console.log(b.data.message),a.loginInProgress=!1,a.loginMessage=b.data.message,a.loginButtonText="Log-in",a.loggedIn=!1})},logout:function(){console.log("logout::logout clicked"),a.loggedIn===!0&&(console.log("logout::preforming logout"),b.logout(),a.loginButtonText="Log-in",a.loggedIn=!1,a.loginInProgress=!1,a.activateRawDataFiltering=!1)}}}]),angular.module("skypathApp").run(["$templateCache",function(a){a.put("views/about.html",'<div class="row"> <br> </div> <div class="row"> <div class="jumbotron aboutPage"> <h1>Skypath</h1> <p>The turbulence hunter !</p> <p>&copy 2015</p> </div> </div>'),a.put("views/main.html",'<section> <div class="container text-center" ng-show="serverOperationInProgress"> <button class="btn btn-xs btn-warning"><span class="glyphicon glyphicon-refresh glyphicon-refresh-animate"></span> Loading...</button> </div> <div class="form-group"> <div class="col-xs-{{sideBarColWidth}}"> <br> <div class="form-group" style="border-radius: 5px" ng-show="activateRawDataFiltering"> <div class="panel panel-primary"> <pre class="panel-heading">Data filtering</pre> <div class="panel-body"> <input class="form-group" placeholder="Employee Id (e.g e098288)" ng-model="emplyeeIdFilterFromServer"> <input class="form-group" placeholder="Flight #" ng-model="flightNumberFilterFromServer"> <div> <button class="btn btn-success" ng-click="viewMethods.reportFilter()">filter</button> <!-- <span ng-show=\'serverOperationInProgress\' name="spinner3" img-src="../spinner.gif" class="ng-isolate-scope">  \n            <img height=\'30\' ng-show="true" src="../spinner.gif">  \n            </span> --> </div> </div> </div> </div> <div class="panel panel-default" ng-show="tileDataExpanded && activateRawDataFiltering" style="height: 380px !important;overflow: scroll"> <div class="panel-heading"><b>Tile: {{tileReports[0].tileX}},{{tileReports[0].tileY}}</b></div> <table class="table table-bordered"> <thead> <tr> <th>#</th> <th>Time</th> <th>Alt.</th> <!-- <input  ng-model=\'flightNumberFilter\'> --> <th>Sev.</th> <th>Flight #</th> <!-- <th>\n                <input ng-model=\'flightNumberFilter\'>\n              </th> --> <th class="col-xs-2">empId.</th> </tr> </thead> <tbody> <tr ng-repeat="tileReport in tileReports | filter:flightNumberFilter | orderBy:\'-timestamp\'"> <td class="col-xs-2">{{$index}}</td> <td class="col-xs-2">{{tileReport.humenTime}}</td> <td class="col-xs-2">{{tileReport.alt}}</td> <td class="col-xs-2">{{tileReport.severity}}</td> <td class="col-xs-2">{{tileReport.fNum}}</td> <td class="col-xs-2">{{tileReport.empId}}</td> </tr> </tbody> </table> </div> <div class="form-group" ng-show="!activateRawDataFiltering" style="background-color:#002000; border-radius: 5px"> <ul class="nav nav-pills"> <li ng-class="{active: selectedUITab===1}"> <a href style="font-size:small" ng-click="viewMethods.setDisplayTilesByAltAndTime();selectedUITab=1">Filter by Alt.</a></li> <li ng-class="{active: selectedUITab===2}"><a href style="font-size:small" ng-click="viewMethods.setDisplayAllTiles();selectedUITab=2">Show all Alt.</a></li> </ul> <div ng-show="selectedUITab===1" style="padding: 15px"> <button class="btn btn-info btn-block" type="button" ng-click="viewMethods.goUP()">Up </button> <pre style="margin-bottom: 0;color:#000000" class="text-center">{{currentAltitudeLabel}}</pre> <button class="btn btn-primary btn-block" type="button" ng-click="viewMethods.goDOWN()">Down </button> <br> <br> <!-- time controls--> <label style="color:#C0C0C0">History</label> <pre style="color:#000000" class="text-center">Last {{currentTimeSpan}} hours</pre> <slider ng-model="currentTimeSpan" min="6" step="6" max="504"></slider> <br> <label style="color:#C0C0C0">Events at Alt. / time</label> <pre class="text-center">{{noOfTilesForAltAndTime}} / {{noOfTilesForAlt}} events</pre> <br> <br> <label style="color:#C0C0C0">Total events</label> <pre class="text-center" style="color:#000000">{{noOfTotalTiles}} events</pre> </div> <div ng-show="selectedUITab===2" id="all" style="padding: 15px"> <!-- time controls--> <label style="color:#C0C0C0">History</label> <pre style="color:#000000" class="text-center">Last {{currentTimeSpan}} hours</pre> <slider ng-model="currentTimeSpan" ng-mouseup="viewMethods.sliderMouseReleased()" min="6" step="6" max="504"></slider> <br> <label style="color:#C0C0C0">Events at timespan</label> <pre class="text-center">{{noOfTilesAtTimespan}}</pre> <br> <br> <label style="color:#C0C0C0">Total events</label> <pre class="text-center" style="color:#000000">{{noOfTotalTiles}} events</pre> </div> </div> </div> <div class="col-xs-{{mapColWidth}}"> <leaflet name="leafletCtrl" style="border-style: solid" center="center" layers="layers" controls class="mainmap"></leaflet> </div> </div> </section>')}]);